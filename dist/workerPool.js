"use strict";function getUuid(){for(var r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),e=[],t=0;t<10;t++)e[t]=r[10*Math.random()];return e.join("")}function TaskPool(r){r||(r={}),extend(r,defaultOptions$1),this.maxTaskNum=r.maxTaskNum,this._tasks=[],this._runningWorker=0}function deferPromise(){var r={};return r.promise=new Promise(function(e,t){r.resolve=e,r.reject=t}),r}function WorkerPool(r){r||(r={}),extend(r,defaultOptions),this._taskPool=new TaskPool({maxTaskNum:r.maxWorkers}),this._workers=[]}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},isValidObjectWith=function(r){return function(e){return!!e&&!Array.isArray(e)&&r.every(function(r){return e.hasOwnProperty(r)})}},isValidAction=function(r){return isValidObjectWith(["message","func"])(r)&&"function"==typeof r.func&&"string"==typeof r.message},isValidActionsArray=function(r){return r.every(isValidAction)},isValidPostParams=function(r){return isValidObjectWith(["message","args"])(r)&&Array.isArray(r.args)&&"string"==typeof r.message},isValidPostParamsArray=function(r){return r.every(isValidPostParams)},isValidObjectsArray=function(r){return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return r.every(isValidObjectWith(e))}},testArray={actionsArray:function(r){return isValidActionsArray(r)},arraysArray:function(r){return r.every(function(r){return Array.isArray(r)})},objectsArray:function(r){return isValidObjectsArray(r)()},postParamsArray:function(r){return isValidPostParamsArray(r)},stringsArray:function(r){return r.every(function(r){return"string"==typeof r})}},isValidArg=function(r){return function(e){return"null"===e?null===r:"undefined"===e?void 0===r:"action"===e?isValidAction(r):Array.isArray(r)?!("array"!==e&&!testArray[e])&&("array"===e||testArray[e](r)):!!r&&(void 0===r?"undefined":_typeof(r))===e.toString()}},isValid=function(r){return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return Array.isArray(e)?e.some(function(e){return isValidArg(r)(e)}):!!isValidArg(r)(e)}},argumentError=function(r){var e=r.expected,t=void 0===e?"":e,n=r.received,o=r.extraInfo,i=void 0===o?"":o;try{return new TypeError("You should provide "+t+"\n"+i+"\nReceived: "+JSON.stringify(n))}catch(r){if(r.message.includes("Converting circular structure to JSON"))return new TypeError("You should provide "+t+"\n"+i+"\nReceived a circular structure: "+n);throw r}},getLocalhostPath=function(){if("file:"===window.location.protocol){return"file://"+window.location.pathname.replace(/\/[^/]+\.html/i,"")}return window.location.origin},makeResponse=function(r){return"\n  const action = "+r+"\n  self.__path = '"+getLocalhostPath()+"'\n  self.onmessage = function(event) {\n    const args = event.data.message.args\n    self.postMessage(action.apply(null, args))\n    return close()\n  }\n  self.onerror = function(event) {\n      return close()\n  }\n"},extend=function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)t.hasOwnProperty(n)&&!r[n]&&(r[n]=t[n])}},createDisposableWorker=function(r){var e=window.URL||window.webkitURL,t=new Blob([r],{type:"application/javascript"}),n=e.createObjectURL(t),o=new Worker(n);return o.post=function(r){return new Promise(function(t,i){o.onmessage=function(r){e.revokeObjectURL(n),t(r.data)},o.onerror=function(r){console.error("Error: Line "+r.lineno+" in "+r.filename+": "+r.message),e.revokeObjectURL(n),i(r)},o.postMessage({message:r})})},o.cancel=function(){o.terminate(),e.revokeObjectURL(n)},o},run=function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments[1],t=arguments[2],n=isValid(r)("function"),o=isValid(e)(["array","undefined"]);return new Promise(function(i,s){if(n&&o){var a=createDisposableWorker(makeResponse(r));t&&(t.promise.cancel=function(){a.cancel(),s("cancelled")}),a.post({args:e}).then(function(r){i(r)}).catch(function(r){s(r)})}else n||console.error(argumentError({expected:"a function",received:r})),o||console.error(argumentError({expected:"an array",received:e})),s("parameter error")})},runStateSet={NOT_STARTED:-1,RUNNING:0,OVER:1},resultSet={REJECTED:-1,PENDING:0,RESOLVED:1},defaultOptions$1={maxTaskNum:3};TaskPool.prototype.addTask=function(r,e,t){function n(r){this._removeTask=!0;var e=this._tasks.findIndex(function(r){return r.id===o});if(e>-1){var t=this._tasks[e];this._tasks.splice(e,1),t.status.remove=!0}this._removeTask=!1,r("cancelled")}if(!(r instanceof Function))throw Error("method not a function");var o="task_"+getUuid(),i={id:o,method:r,params:e,status:{runStatus:runStateSet.NOT_STARTED,resultStatus:resultSet.PENDING,remove:!1},resolver:t};this._tasks.push(i),t.promise.cancel=n.bind(this,t.reject)},TaskPool.prototype.next=function(){var r=this;if(this._tasks.length){if(this._removeTask||this._runningWorker>=this.maxTaskNum)return void setTimeout(function(){r.next()},17);var e=this._tasks.shift();if(e.status.remove)return;e.status.runStatus=runStateSet.RUNNING,this._runningWorker++,run(e.method,e.params,e.resolver).then(function(r){e.resolver.resolve(r),e.status.resultStatus=resultSet.RESOLVED}).catch(function(r){e.resolver.reject(r),e.status.resultStatus=resultSet.REJECTED}).then(function(){e.status.runStatus=runStateSet.OVER,r._runningWorker--}),this._tasks.length&&setTimeout(function(){r.next()})}};var defaultOptions={maxWorkers:3};WorkerPool.prototype.addWorker=function(r){if(Array.isArray(r)||(r=[r]),!isValid(r)("actionsArray"))throw argumentError({expected:"an array of objects",received:r,extraInfo:"Every action should be an object containing two fields:\n* message\n* func"});for(var e=0;e<r.length;e++)this._workers.push(r[e])},WorkerPool.prototype.removeWorker=function(r){if(isValid(r)("string")){var e=this._workers.findIndex(function(e){return e.message===r});e>-1&&this._workers.splice(e,1)}},WorkerPool.prototype.run=function(r,e){var t=isValid(r)("string"),n=isValid(e)(["array","undefined"]),o=deferPromise();if(t&&n){var i=this._workers.filter(function(e){var t=e.message;return JSON.stringify(t)===JSON.stringify(r)}).map(function(r){return r.func}).pop();i?(this._taskPool.addTask(i,e,o),this._taskPool.next()):o.reject(r+" is not a registered action for this worker")}return t||o.reject(argumentError({expected:"a string",received:r})),n||o.reject(argumentError({expected:"an array",received:e})),o.promise};var createWrapper=function(){return window.Worker?window.URL.createObjectURL||window.webkitURL.createObjectURL?{WorkerPool:WorkerPool}:(console.error("This browser does not have URL.createObjectURL method."),null):(console.error("This browser does not support Workers."),null)},WorkerWrapper=createWrapper();module.exports=WorkerWrapper;
//# sourceMappingURL=workerPool.js.map
